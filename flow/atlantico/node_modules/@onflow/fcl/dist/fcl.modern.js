import*as e from"@onflow/sdk";import{config as t,send as n,getTransactionStatus as a,decode as r,resolve as s,pipe as i,interaction as o,createSignableVoucher as c,latestBlock as u}from"@onflow/sdk";export{TestUtils,account,arg,args,atBlockHeight,atBlockId,authorization,authorizations,build,config,createSignableVoucher,decode,getAccount,getBlock,getBlockByHeight,getBlockById,getBlockHeader,getCollection,getEvents,getEventsAtBlockHeightRange,getEventsAtBlockIds,getLatestBlock,getTransaction,getTransactionStatus,invariant,isBad,isOk,latestBlock,limit,param,params,payer,ping,pipe,proposer,ref,script,send,transaction,validator,why}from"@onflow/sdk";import{invariant as d}from"@onflow/util-invariant";import*as l from"@onflow/types";import{spawn as p,send as f,SUBSCRIBE as y,UNSUBSCRIBE as h,INIT as m,subscriber as g,snapshoter as w,UPDATED as E,SNAPSHOT as S}from"@onflow/util-actor";import{withPrefix as v,sansPrefix as b}from"@onflow/util-address";export{display,sansPrefix,withPrefix}from"@onflow/util-address";import*as R from"@onflow/rlp";import{uid as A}from"@onflow/util-uid";export{template as cadence,template as cdc}from"@onflow/util-template";t().put("accessNode.api","http://localhost:8080").put("challenge.handshake","http://localhost:8700/authenticate");const P="0.0.76",k=e=>t=>typeof t===e,I=e=>null!=e,C=k("object"),T=k("string"),N=k("function"),O=k("number");function _(t){return N(t)?t(e.arg,l):[]}async function x(t={}){return await async function(e){d(I(e.cadence),"query({ cadence }) -- cadence is required"),d(T(e.cadence),"query({ cadence }) -- cadence must be a string")}(t),e.send([e.script(t.cadence),e.args(_(t.args||[])),t.limit&&"number"==typeof t.limit&&e.limit(t.limit)]).then(e.decode)}function L(){return(L=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}const D={f_type:"Service",f_vsn:"1.0.0"},U={f_type:"Identity",f_vsn:"1.0.0"},z={f_type:"USER",f_vsn:"1.0.0"},F={f_type:"PollingResponse",f_vsn:"1.0.0"},H={f_type:"CompositeSignature",f_vsn:"1.0.0"};function j(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({old:e},D,{type:"frame",endpoint:e.endpoint,params:e.params||{},data:e.data||{}})}}function B(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({},D,{type:"back-channel-rpc",endpoint:e.endpoint,method:e.method,params:e.params||{},data:e.data||{}})}}const M={"back-channel-rpc":B,"pre-authz":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({},D,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:L({},U,{address:v(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authz:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({},D,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:L({},U,{address:v(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authn:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({},D,{type:e.type,uid:e.id,endpoint:e.authn,id:e.pid,provider:{address:v(e.addr),name:e.name,icon:e.icon}})}},frame:j,"open-id":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return null}},"user-signature":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:throw new Error("Invalid user-signature service")}}};function J(e){return R.encode([e.provider.address||e.provider.name||"UNSPECIFIED",e.id]).toString("hex")}function K(e=[],t){return e.find(e=>e.type===t)}function q(e){const t=new URL(e.endpoint);if(t.searchParams.append("l6n",window.location.origin),null!=e.params)for(let[n,a]of Object.entries(e.params||{}))t.searchParams.append(n,a);return t}function G(e,t={}){const n=t.method||"POST",a="GET"===n?void 0:JSON.stringify(t.data||e.data||{});return fetch(q(e),{method:n,headers:L({},e.headers||{},t.headers||{},{"Content-Type":"application/json"}),body:a}).then(e=>e.json())}function $(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({},F,{status:e.status,reason:e.reason,data:e.compositeSignature||e.data||{},updates:B(e.authorizationUpdates),local:j((e.local||[])[0])})}}const V="FCL_IFRAME",Y=()=>{},Z=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]);function W(e,t={}){if(null==e)return{send:Y,close:Y};const n=t.onClose||Y,a=t.onMessage||Y,r=t.onReady||Y,s=t.onResponse||Y;window.addEventListener("message",c);const[i,o]=function(e){d(!document.getElementById(V),"Attempt at triggering multiple Frames",{src:e});const t=document.createElement("iframe");return t.src=e,t.id=V,t.allow="usb *; hid *",t.frameBorder="0",t.style.cssText="\n  position:fixed;\n  top: 0px;\n  right: 0px;\n  bottom: 0px;\n  left: 0px;\n  height: 100vh;\n  width: 100vw;\n  display:block;\n  background:rgba(0,0,0,0.25);\n  z-index: 2147483647;\n  box-sizing: border-box;\n",document.body.append(t),[t,()=>{document.getElementById(V)&&document.getElementById(V).remove()}]}(q(e));return{send:l,close:u};function c(e){try{if("object"!=typeof e.data)return;if(Z.has(e.data.type))return;"FCL:FRAME:CLOSE"===e.data.type&&u(),"FCL:FRAME:READY"===e.data.type&&r(e,{send:l,close:u}),"FCL:FRAME:RESPONSE"===e.data.type&&s(e,{send:l,close:u}),a(e,{send:l,close:u}),"FCL::CHALLENGE::RESPONSE"===e.data.type&&s(e,{send:l,close:u}),"FCL::AUTHZ_READY"===e.data.type&&r(e,{send:l,close:u}),"FCL::CHALLENGE::CANCEL"===e.data.type&&u(),"FCL::CANCEL"===e.data.type&&u()}catch(e){console.error("Frame Callback Error",e),u()}}function u(){try{window.removeEventListener("message",c),o(),n()}catch(e){console.error("Frame Close Error",e)}}function l(e){try{i.contentWindow.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Frame Send Error",e,t)}}}const X={"HTTP/GET":"GET","HTTP/POST":"POST"},Q=e=>(d(X[e.method],"Invalid Service Method for type back-channel-rpc",{service:e}),X[e.method]);async function ee(e,t=(()=>!0)){if(d(e,"Missing Polling Service",{service:e}),!t())throw new Error("Externally Halted");const n=await G(e,{method:Q(e)}).then($);switch(n.status){case"APPROVED":return n.data;case"DECLINED":throw new Error(`Declined: ${n.reason||"No reason supplied."}`);default:return await new Promise(e=>setTimeout(e,500)),ee(n.updates,t)}}async function te(e,t,n){t.data=e.data;const a=await G(e,{data:t}).then($);if("APPROVED"===a.status)return a.data;if("DECLINED"===a.status)throw new Error(`Declined: ${a.reason||"No reason supplied."}`);if("PENDING"===a.status){var r=!0;const{close:e}=W(a.local,{onClose(){r=!1}});return ee(a.updates,()=>r).then(t=>(e(),t)).catch(t=>{throw console.error(t),e(),t})}throw console.error("Auto Decline: Invalid Response",{service:e,resp:a}),new Error("Auto Decline: Invalid Response")}const ne={"HTTP/RPC":te,"HTTP/POST":te,"IFRAME/RPC":function(e,t,n){return new Promise((a,r)=>{const s=A(),i=n.includeOlderJsonRpcCall;t.data=e.data,W(e,{onReady(n,{send:a}){try{a({type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data}}),i&&a({jsonrpc:"2.0",id:s,method:"fcl:sign",params:[t,e.params]})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=$(e.data);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==s)return;const n=$(e.data.result);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onMessage error",e),e}},onClose(){r("Declined: Externally Halted")}})})}};async function ae(e,t,n={}){try{return ne[e.method](e,t,n)}catch(a){throw console.error("execService(service, msg)",a,{service:e,msg:t,opts:n}),a}}function re(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return L({},H,{addr:b(e.addr||e.address),signature:e.signature||e.sig,keyId:e.keyId})}}const se="CURRENT_USER",ie="CURRENT_USER/UPDATED",oe='{\n  "f_type": "User",\n  "f_vsn": "1.0.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "expiresAt":null,\n  "services":[]\n}',ce=async e=>(sessionStorage.setItem(se,JSON.stringify(e)),e),ue=()=>t().get("persistSession",!0),de={[m]:async e=>{if(e.merge(JSON.parse(oe)),await ue()){const t=await(async()=>{const e=JSON.parse(oe),t=JSON.parse(sessionStorage.getItem(se));return null!=t&&e.f_vsn!==t.f_vsn?(sessionStorage.removeItem(se),e):t||e})();pe(t)&&e.merge(t)}},[y]:(e,t)=>{e.subscribe(t.from),e.send(t.from,ie,L({},e.all()))},[h]:(e,t)=>{e.unsubscribe(t.from)},SNAPSHOT:async(e,t)=>{t.reply(L({},e.all()))},SET_CURRENT_USER:async(e,t,n)=>{e.merge(n),await ue()&&ce(e.all()),e.broadcast(ie,L({},e.all()))},DEL_CURRENT_USER:async(e,t)=>{e.merge(JSON.parse(oe)),await ue()&&ce(e.all()),e.broadcast(ie,L({},e.all()))}},le=()=>p(de,se);function pe(e){return null==e.expiresAt||0===e.expiresAt||e.expiresAt>Date.now()}async function fe(e){return Object.fromEntries(Object.entries(await t().where(e)).map(([t,n])=>[t.replace(e,""),n]))}async function ye(e={}){return new Promise(async(n,a)=>{le();const r=await we();if(r.loggedIn&&pe(r))return n(r);(e.serviceStrategy||W)({endpoint:await t.first(["discovery.wallet","challenge.handshake"])},{async onReady(e,{send:t}){t({type:"FCL:AUTHN:CONFIG",services:await fe(/^service\./),app:await fe(/^app\.detail\./)})},async onClose(){n(await we())},async onResponse(e,{close:t}){f(se,"SET_CURRENT_USER",await async function(e){var t=function(e=[],t=[]){return[...e,...t]}((e=function(e){return e.addr=e.addr?v(e.addr):null,e.paddr=e.paddr?v(e.paddr):null,e}(e)).services||[],await async function(e,t){if(null==e||null==t)return[];const n=new URL(e);n.searchParams.append("code",t);const a=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json());if(Array.isArray(a))return a;const r=[];if(Array.isArray(a.authorizations))for(let e of a.authorizations)r.push(L({type:"authz",keyId:a.keyId},e));return null!=a.provider&&r.push(L({type:"authn",id:"wallet-provider#authn"},a.provider)),r}(e.hks,e.code)).map(t=>function(e,t){try{return M[e.type](e,t)}catch(t){return console.error(`Unrecognized FCL Service Type [${e.type}]`,e,t),e}}(t,e));const n=function(e,t){return t.find(e=>"authn"===e.type)}(0,t);return L({},z,{addr:v(e.addr),cid:J(n),loggedIn:!0,services:t,expiresAt:e.exp})}(e.data)),n(await we()),t()}})})}function he(){le(),f(se,"DEL_CURRENT_USER")}async function me(e){le();const t=await ye(),n=K(t.services,"authz"),a=K(t.services,"pre-authz");return L({},e,a?{tempId:"CURRENT_USER",resolve:async(e,t)=>function(e){const t=(e=>({f_type:"PreAuthzResponse",f_vsn:"1.0.0",proposer:(e||{}).proposer,payer:(e||{}).payer||[],authorization:(e||{}).authorization||[]}))(e),n=[];null!=t.proposer&&n.push(["PROPOSER",t.proposer]);for(let e of t.payer||[])n.push(["PAYER",e]);for(let e of t.authorization||[])n.push(["AUTHORIZER",e]);return n.map(([e,t])=>({tempId:[t.identity.address,t.identity.keyId].join("|"),addr:t.identity.address,keyId:t.identity.keyId,signingFunction:e=>ae(t,e),role:{proposer:"PROPOSER"===e,payer:"PAYER"===e,authorizer:"AUTHORIZER"===e}}))}(await ae(a,t))}:{tempId:"CURRENT_USER",resolve:null,addr:b(n.identity.address),keyId:n.identity.keyId,sequenceNum:null,signature:null,signingFunction:async e=>re(await ae(n,e,{includeOlderJsonRpcCall:!0}))})}function ge(e){le();const t="@EXIT",n=p(async n=>{for(n.send(se,y);;){const a=await n.receive();if(a.tag===t)return void n.send(se,h);e(a.data)}});return()=>f(n,t)}function we(){return le(),f(se,"SNAPSHOT",null,{expectReply:!0,timeout:0})}async function Ee(e,t={}){le();const n=K((await ye(t)).services,"user-signature");d(n,"Current user must have authorized a signing service.");try{const t=await ae(n,(e=>(d(/^[0-9a-f]+$/i.test(e),"Message must be a hex string"),{message:e}))(e));return Array.isArray(t)?t.map(e=>re(e)):[re(t)]}catch(e){return e}}async function Se(e,t){d(/^[0-9a-f]+$/i.test(e),"Message must be a hex string"),d(Array.isArray(t),"Must include an Array of composite signatures");let n=[],a=[],r=[];const s=await Promise.all(t.map(async e=>{d("string"==typeof e.addr,"addr must be a string"),d("number"==typeof e.keyId,"keyId must be a number"),d("string"==typeof e.signature,"signature must be a string");try{const t=await t(e.addr);return n.push(t.keys[e.keyId].weight.toFixed(1)),a.push(t.keys[e.keyId].signAlgo),r.push(e.signature),t.keys[e.keyId].publicKey}catch(e){throw e}}));return await fcl.query({cadence:"\nimport Crypto\n    \npub fun main(\n  message: String,\n  rawPublicKeys: [String],\n  weights: [UFix64],\n  signAlgos: [UInt],\n  signatures: [String],\n): Bool {\n\n  let keyList = Crypto.KeyList()\n  \n  var i = 0\n  for rawPublicKey in rawPublicKeys {\n    keyList.add(\n      PublicKey(\n        publicKey: rawPublicKey.decodeHex(),\n        signatureAlgorithm: signAlgos[i] == 2 ? SignatureAlgorithm.ECDSA_P256 : SignatureAlgorithm.ECDSA_secp256k1 \n      ),\n      hashAlgorithm: HashAlgorithm.SHA3_256,\n      weight: weights[i],\n    )\n    i = i + 1\n  }\n\n  let signatureSet: [Crypto.KeyListSignature] = []\n\n  var j = 0\n  for signature in signatures {\n    signatureSet.append(\n      Crypto.KeyListSignature(\n        keyIndex: j,\n        signature: signature.decodeHex()\n      )\n    )\n    j = j + 1\n  }\n    \n  let signedData = message.decodeHex()\n  \n  return keyList.verify(\n    signatureSet: signatureSet,\n    signedData: signedData\n  )\n}\n",args:(t,i)=>[t(e,i.String),t(s,i.Array([i.String])),t(n,i.Array(i.UFix64)),t(a,i.Array([i.UInt])),t(r,i.Array([i.String]))]})}const ve=()=>({authenticate:ye,unauthenticate:he,authorization:me,signUserMessage:Ee,verifyUserSignatures:Se,subscribe:ge,snapshot:we}),be=async e=>n([a(e)]).then(r),Re=e=>e.status>=4,Ae=e=>e.status>=3,Pe=e=>e.status>=2,ke={[m]:async e=>{const t=await be(e.self());Re(t)||setTimeout(()=>e.sendSelf("POLL"),2500),e.merge(t)},[y]:(e,t)=>{e.subscribe(t.from),e.send(t.from,E,e.all())},[h]:(e,t)=>{e.unsubscribe(t.from)},[S]:async(e,t)=>{t.reply(e.all())},POLL:async e=>{const t=await be(e.self());var n,a;Re(t)||setTimeout(()=>e.sendSelf("POLL"),2500),n=e.all(),a=t,JSON.stringify(n)!==JSON.stringify(a)&&e.broadcast(E,t),e.merge(t)}},Ie=e=>{if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},Ce=e=>p(ke,Ie(e));function Te(e){function t(t){return g(Ie(e),Ce,t)}function n(e){return function(n={}){const a=n.suppress||!1;return new Promise((n,r)=>{const s=t(t=>{t.statusCode&&!a?(r(t.errorMessage),s()):e(t)&&(n(t),s())})})}}return{snapshot:function(){return w(e,Ce)},subscribe:t,onceFinalized:n(Pe),onceExecuted:n(Ae),onceSealed:n(Re)}}async function Ne(t={}){try{await async function(e){d(I(e),"mutate(opts) -- opts is required"),d(C(e),"mutate(opts) -- opts must be an object"),d(I(e.cadence),"mutate({ cadence }) -- cadence is required"),d(T(e.cadence),"mutate({ cadence }) -- cadence must be a string")}(t);const n=await e.config().get("fcl.authz",ve().authorization);return e.send([e.transaction(t.cadence),e.args(_(t.args||[])),t.limit&&O(t.limit)&&e.limit(t.limit),e.proposer(t.proposer||t.authz||n),e.payer(t.payer||t.authz||n),e.authorizations(t.authorizations||[t.authz||n])]).then(e.decode)}catch(e){throw e}}Te.isUnknown=e=>e.status>=0,Te.isPending=e=>e.status>=1,Te.isFinalized=Pe,Te.isExecuted=Ae,Te.isSealed=Re,Te.isExpired=e=>5===e.status;const Oe=async(e=[],n={})=>{const a=await t.first(["sdk.resolve"],n.resolve||s);return Array.isArray(e)&&(e=await i(o(),e)),JSON.stringify(c(await a(e)),null,2)},_e=async e=>setTimeout(()=>e.sendSelf("TICK"),await t().get("fcl.eventPollRate",1e4)),xe={TICK:async e=>{if(!e.hasSubs())return;let t=e.get("hwm");if(null==t)e.put("hwm",await u()),e.put("tick",await _e(e));else{let a=await u();e.put("hwm",a);const s=await n([getEvents(e.self(),t.height,a.height-1)]).then(r);for(let t of s)e.broadcast("UPDATED",t.data);e.put("tick",await _e(e))}},[y]:async(e,t)=>{e.hasSubs()||e.put("tick",await _e(e)),e.subscribe(t.from)},[h]:(e,t)=>{e.unsubscribe(t.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))}},Le=e=>p(xe,e);function De(e){return{subscribe:t=>g(e,Le,t)}}const Ue=e=>ve().authenticate(e),ze=()=>ve().unauthenticate(),Fe=()=>(ve().unauthenticate(),ve().authenticate()),He=e=>ve().authenticate(),je=e=>ve().authenticate(),Be=ve().authorization,Me=l;export{P as VERSION,Ue as authenticate,Be as authz,ve as currentUser,De as events,je as logIn,Ne as mutate,x as query,Fe as reauthenticate,Oe as serialize,He as signUp,Me as t,Te as tx,ze as unauthenticate};
//# sourceMappingURL=fcl.modern.js.map
