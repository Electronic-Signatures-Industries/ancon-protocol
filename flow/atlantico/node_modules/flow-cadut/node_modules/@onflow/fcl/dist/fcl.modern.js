import*as e from"@onflow/sdk";import{config as t,send as n,getTransactionStatus as a,decode as r,resolve as s,pipe as o,interaction as i,createSignableVoucher as c,latestBlock as d,encodeMessageFromSignable as l}from"@onflow/sdk";export{TestUtils,account,arg,args,atBlockHeight,atBlockId,authorization,authorizations,build,config,createSignableVoucher,decode,getAccount,getBlock,getBlockByHeight,getBlockById,getBlockHeader,getCollection,getEvents,getEventsAtBlockHeightRange,getEventsAtBlockIds,getLatestBlock,getTransaction,getTransactionStatus,invariant,isBad,isOk,latestBlock,limit,param,params,payer,ping,pipe,proposer,ref,script,send,transaction,validator,why}from"@onflow/sdk";import{invariant as u}from"@onflow/util-invariant";import*as p from"@onflow/types";import{spawn as f,send as y,SUBSCRIBE as E,UNSUBSCRIBE as g,INIT as m,subscriber as h,snapshoter as w,UPDATED as C,SNAPSHOT as R}from"@onflow/util-actor";import{withPrefix as S,sansPrefix as v}from"@onflow/util-address";export{display,sansPrefix,withPrefix}from"@onflow/util-address";import*as L from"@onflow/rlp";import{uid as P}from"@onflow/util-uid";export{template as cadence,template as cdc}from"@onflow/util-template";async function A(e){return Object.fromEntries(Object.entries(await t().where(e)).map(([t,n])=>[t.replace(e,""),n]))}t({"discovery.wallet.method.default":"IFRAME/RPC","fcl.storage.default":{can:!0,get:async e=>JSON.parse(sessionStorage.getItem(e)),put:async(e,t)=>sessionStorage.setItem(e,JSON.stringify(t))}});const I="0.0.77",b=e=>t=>typeof t===e,F=e=>null!=e,O=b("object"),N=b("string"),D=b("function"),k=b("number");function T(t){return D(t)?t(e.arg,p):[]}async function _(t={}){return await async function(t){u(F(t.cadence),"query({ cadence }) -- cadence is required"),u(N(t.cadence),"query({ cadence }) -- cadence must be a string"),u(await e.config.get("accessNode.api"),'Required value for "accessNode.api" not defined in config. See: https://github.com/onflow/flow-js-sdk/blob/master/packages/fcl/src/exec/query.md#configuration')}(t),e.send([e.script(t.cadence),e.args(T(t.args||[])),t.limit&&"number"==typeof t.limit&&e.limit(t.limit)]).then(e.decode)}function V(){return(V=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}const x={f_type:"Service",f_vsn:"1.0.0"},U={f_type:"Identity",f_vsn:"1.0.0"},W={f_type:"USER",f_vsn:"1.0.0"},M={f_type:"PollingResponse",f_vsn:"1.0.0"},z={f_type:"CompositeSignature",f_vsn:"1.0.0"};function j(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return V({old:e},x,{type:"frame",endpoint:e.endpoint,params:e.params||{},data:e.data||{}})}}function H(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return V({},x,{type:"back-channel-rpc",endpoint:e.endpoint,method:e.method,params:e.params||{},data:e.data||{}})}}function Y(e){if(null==e)return null;switch(null==e.method&&(e=V({},e,{type:"local-view",method:"VIEW/IFRAME"})),e.f_vsn){case"1.0.0":return e;default:return V({},x,{type:e.type||"local-view",method:e.method,endpoint:e.endpoint,data:e.data||{},params:e.params||{}})}}const $={"back-channel-rpc":H,"pre-authz":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return V({},x,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:V({},U,{address:S(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authz:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return V({},x,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:V({},U,{address:S(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authn:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return V({},x,{type:e.type,uid:e.id,endpoint:e.authn,id:e.pid,provider:{address:S(e.addr),name:e.name,icon:e.icon}})}},frame:j,"open-id":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return null}},"user-signature":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:throw new Error("Invalid user-signature service")}},"local-view":Y};function B(e){return L.encode([e.provider.address||e.provider.name||"UNSPECIFIED",e.id]).toString("hex")}function J(e=[],t){return e.find(e=>e.type===t)}function q(e){const t=new URL(e.endpoint);if(t.searchParams.append("l6n",window.location.origin),null!=e.params)for(let[n,a]of Object.entries(e.params||{}))t.searchParams.append(n,a);return t}function K(e,t={}){const n=t.method||"POST",a="GET"===n?void 0:JSON.stringify(t.data||e.data||{});return fetch(q(e),{method:n,headers:V({},e.headers||{},t.headers||{},{"Content-Type":"application/json"}),body:a}).then(e=>e.json())}function G(e){var t;if(null==e)return null;switch((e.addr||e.services)&&(e={status:"APPROVED",data:V({},e)}),e.f_vsn){case"1.0.0":return e;default:return V({},M,{status:e.status,reason:null!=(t=e.reason)?t:null,data:e.compositeSignature||e.data||{},updates:H(e.authorizationUpdates),local:j((e.local||[])[0])})}}const Z={"HTTP/GET":"GET","HTTP/POST":"POST"},X=e=>(u(Z[e.method],"Invalid Service Method for type back-channel-rpc",{service:e}),Z[e.method]);async function Q(e,t=(()=>!0)){if(u(e,"Missing Polling Service",{service:e}),!t())throw new Error("Externally Halted");const n=await K(e,{method:X(e)}).then(G);switch(n.status){case"APPROVED":return n.data;case"DECLINED":throw new Error(`Declined: ${n.reason||"No reason supplied."}`);default:return await new Promise(e=>setTimeout(e,500)),Q(n.updates,t)}}const ee="FCL_IFRAME";function te(e){u(!document.getElementById(ee),"Attempt at triggering multiple Frames",{src:e});const t=document.createElement("iframe");return t.src=e,t.id=ee,t.allow="usb *; hid *",t.frameBorder="0",t.style.cssText="\n  position:fixed;\n  top: 0px;\n  right: 0px;\n  bottom: 0px;\n  left: 0px;\n  height: 100vh;\n  width: 100vw;\n  display:block;\n  background:rgba(0,0,0,0.25);\n  z-index: 2147483647;\n  box-sizing: border-box;\n",document.body.append(t),[t.contentWindow,()=>{document.getElementById(ee)&&document.getElementById(ee).remove()}]}let ne=null,ae=null;function re(e,t,n,a,r){return n.open(e,t,`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${a}, height=${r}, top=${n.top.outerHeight/2+n.top.screenY-r/2}, left=${n.top.outerWidth/2+n.top.screenX-a/2}`)}function se(e){var t;null==ne||null!=(t=ne)&&t.closed?ne=re(e,"FCL_POP",window,640,600):ae!==e?(ne=re(e,"FCL_POP",window,640,600),ne.focus()):ne.focus(),ae=e;var n=setInterval(function(){ne&&ne.closed&&(clearInterval(n),ne=null)},1e3);return[ne,()=>{ne&&!ne.closed&&(ne.close(),ne=null)}]}let oe=null,ie=null;function ce(e){var t;null==oe||null!=(t=oe)&&t.closed?oe=window.open(e,"_blank"):ie!==e?(oe=window.open(e,"_blank"),oe.focus()):oe.focus(),ie=e;var n=setInterval(function(){oe&&oe.closed&&(clearInterval(n),oe=null)},1e3);return[oe,()=>{oe&&!oe.closed&&(oe.close(),oe=null)}]}const de={"VIEW/IFRAME":te,"VIEW/POP":se,"VIEW/TAB":ce};async function le(e,t,n={}){t.data=e.data;const a=await K(e,{data:t}).then(G);if("APPROVED"===a.status)return a.data;if("DECLINED"===a.status)throw new Error(`Declined: ${a.reason||"No reason supplied."}`);if("PENDING"===a.status){var r=!0;const[e,t]=await async function(e,t={}){try{return de[e.method](q(e),t)}catch(n){throw console.error("execLocal({service, opts = {}})",n,{service:e,opts:t}),n}}(Y(a.local)),n=()=>{try{t(),r=!1}catch(e){console.error("Frame Close Error",e)}};return Q(a.updates,()=>r).then(e=>(n(),e)).catch(e=>{throw console.error(e),n(),e})}throw console.error("Auto Decline: Invalid Response",{service:e,resp:a}),new Error("Auto Decline: Invalid Response")}const ue=()=>{},pe=e=>"string"==typeof e&&e.toLowerCase(),fe=(e,t)=>console.warn("DEPRECATION NOTICE",`Received ${e}, please use ${t} for this and future versions of FCL`),ye=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]),Ee=()=>{},ge=e=>"string"==typeof e&&e.toLowerCase(),me=(e,t)=>console.warn("DEPRECATION NOTICE",`Received ${e}, please use ${t} for this and future versions of FCL`),he=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]),we=()=>{},Ce=e=>"string"==typeof e&&e.toLowerCase(),Re=(e,t)=>console.warn("DEPRECATION NOTICE",`Received ${e}, please use ${t} for this and future versions of FCL`),Se=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]),ve={"HTTP/RPC":le,"HTTP/POST":le,"IFRAME/RPC":function(e,t,n){return new Promise((a,r)=>{const s=P(),o=n.includeOlderJsonRpcCall;t.data=e.data,function(e,t={}){if(null==e)return{send:ue,close:ue};const n=t.onClose||ue,a=t.onMessage||ue,r=t.onReady||ue,s=t.onResponse||ue;window.addEventListener("message",c);const[o,i]=te(q(e));return{send:l,close:d};function c(e){try{if("object"!=typeof e.data)return;if(ye.has(e.data.type))return;pe(e.data.type)===pe("FCL:VIEW:CLOSE")&&d(),pe(e.data.type)===pe("FCL:VIEW:READY")&&r(e,{send:l,close:d}),pe(e.data.type)===pe("FCL:VIEW:RESPONSE")&&s(e,{send:l,close:d}),a(e,{send:l,close:d}),pe(e.data.type)===pe("FCL:FRAME:READY")&&(fe(e.data.type,"FCL:VIEW:READY"),r(e,{send:l,close:d})),pe(e.data.type)===pe("FCL:FRAME:RESPONSE")&&(fe(e.data.type,"FCL:VIEW:RESPONSE"),s(e,{send:l,close:d})),pe(e.data.type)===pe("FCL:FRAME:CLOSE")&&(fe(e.data.type,"FCL:VIEW:CLOSE"),d()),pe(e.data.type)===pe("FCL::CHALLENGE::RESPONSE")&&(fe(e.data.type,"FCL:VIEW:RESPONSE"),s(e,{send:l,close:d})),pe(e.data.type)===pe("FCL::AUTHZ_READY")&&(fe(e.data.type,"FCL:VIEW:READY"),r(e,{send:l,close:d})),pe(e.data.type)===pe("FCL::CHALLENGE::CANCEL")&&(fe(e.data.type,"FCL:VIEW:CLOSE"),d()),pe(e.data.type)===pe("FCL::CANCEL")&&(fe(e.data.type,"FCL:VIEW:CLOSE"),d())}catch(e){console.error("Frame Callback Error",e),d()}}function d(){try{window.removeEventListener("message",c),i(),n()}catch(e){console.error("Frame Close Error",e)}}function l(e){try{o.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Frame Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({type:"FCL:VIEW:READY:RESPONSE",body:t,service:{params:e.params,data:e.data},config:{services:await A(/^service\./),app:await A(/^app\.detail\./)}}),a({type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data},config:{services:await A(/^service\./),app:await A(/^app\.detail\./)},deprecated:{message:"FCL:FRAME:READY:RESPONSE is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}}),o&&a({jsonrpc:"2.0",id:s,method:"fcl:sign",params:[t,e.params],deprecated:{message:"jsonrpc is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=G(e.data);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==s)return;const n=G(e.data.result);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onMessage error",e),e}},onClose(){r("Declined: Externally Halted")}})})},"POP/RPC":function(e,t,n){return new Promise((a,r)=>{const s=P(),o=n.includeOlderJsonRpcCall;t.data=e.data,function(e,t={}){if(null==e)return{send:Ee,close:Ee};const n=t.onClose||Ee,a=t.onMessage||Ee,r=t.onReady||Ee,s=t.onResponse||Ee;window.addEventListener("message",c);const[o,i]=se(q(e));return{send:l,close:d};function c(e){try{if("object"!=typeof e.data)return;if(he.has(e.data.type))return;ge(e.data.type)===ge("FCL:VIEW:CLOSE")&&d(),ge(e.data.type)===ge("FCL:VIEW:READY")&&r(e,{send:l,close:d}),ge(e.data.type)===ge("FCL:VIEW:RESPONSE")&&s(e,{send:l,close:d}),a(e,{send:l,close:d}),ge(e.data.type)===ge("FCL:FRAME:READY")&&(me(e.data.type,"FCL:VIEW:READY"),r(e,{send:l,close:d})),ge(e.data.type)===ge("FCL:FRAME:RESPONSE")&&(me(e.data.type,"FCL:VIEW:RESPONSE"),s(e,{send:l,close:d})),ge(e.data.type)===ge("FCL:FRAME:CLOSE")&&(me(e.data.type,"FCL:VIEW:CLOSE"),d()),ge(e.data.type)===ge("FCL::CHALLENGE::RESPONSE")&&(me(e.data.type,"FCL:VIEW:RESPONSE"),s(e,{send:l,close:d})),ge(e.data.type)===ge("FCL::AUTHZ_READY")&&(me(e.data.type,"FCL:VIEW:READY"),r(e,{send:l,close:d})),ge(e.data.type)===ge("FCL::CHALLENGE::CANCEL")&&(me(e.data.type,"FCL:VIEW:CLOSE"),d()),ge(e.data.type)===ge("FCL::CANCEL")&&(me(e.data.type,"FCL:VIEW:CLOSE"),d())}catch(e){console.error("Popup Callback Error",e),d()}}function d(){try{window.removeEventListener("message",c),i(),n()}catch(e){console.error("Popup Close Error",e)}}function l(e){try{o.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Popup Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({type:"FCL:VIEW:READY:RESPONSE",body:t,service:{params:e.params,data:e.data},config:{services:await A(/^service\./),app:await A(/^app\.detail\./)}}),a({type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data},config:{services:await A(/^service\./),app:await A(/^app\.detail\./)},deprecated:{message:"FCL:FRAME:READY:RESPONSE is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}}),o&&a({jsonrpc:"2.0",id:s,method:"fcl:sign",params:[t,e.params]})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=G(e.data);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==s)return;const n=G(e.data.result);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onMessage error",e),e}},onClose(){r("Declined: Externally Halted")}})})},"TAB/RPC":function(e,t,n){return new Promise((a,r)=>{const s=P(),o=n.includeOlderJsonRpcCall;t.data=e.data,function(e,t={}){if(null==e)return{send:we,close:we};const n=t.onClose||we,a=t.onMessage||we,r=t.onReady||we,s=t.onResponse||we;window.addEventListener("message",c);const[o,i]=ce(q(e));return{send:l,close:d};function c(e){try{if("object"!=typeof e.data)return;if(Se.has(e.data.type))return;Ce(e.data.type)===Ce("FCL:VIEW:CLOSE")&&d(),Ce(e.data.type)===Ce("FCL:VIEW:READY")&&r(e,{send:l,close:d}),Ce(e.data.type)===Ce("FCL:VIEW:RESPONSE")&&s(e,{send:l,close:d}),a(e,{send:l,close:d}),Ce(e.data.type)===Ce("FCL:FRAME:READY")&&(Re(e.data.type,"FCL:VIEW:READY"),r(e,{send:l,close:d})),Ce(e.data.type)===Ce("FCL:FRAME:RESPONSE")&&(Re(e.data.type,"FCL:VIEW:RESPONSE"),s(e,{send:l,close:d})),Ce(e.data.type)===Ce("FCL:FRAME:CLOSE")&&(Re(e.data.type,"FCL:VIEW:CLOSE"),d()),Ce(e.data.type)===Ce("FCL::CHALLENGE::RESPONSE")&&(Re(e.data.type,"FCL:VIEW:RESPONSE"),s(e,{send:l,close:d})),Ce(e.data.type)===Ce("FCL::AUTHZ_READY")&&(Re(e.data.type,"FCL:VIEW:READY"),r(e,{send:l,close:d})),Ce(e.data.type)===Ce("FCL::CHALLENGE::CANCEL")&&(Re(e.data.type,"FCL:VIEW:CLOSE"),d()),Ce(e.data.type)===Ce("FCL::CANCEL")&&(Re(e.data.type,"FCL:VIEW:CLOSE"),d())}catch(e){console.error("Tab Callback Error",e),d()}}function d(){try{window.removeEventListener("message",c),i(),n()}catch(e){console.error("Tab Close Error",e)}}function l(e){try{o.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Tab Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({type:"FCL:VIEW:READY:RESPONSE",body:t,service:{params:e.params,data:e.data},config:{services:await A(/^service\./),app:await A(/^app\.detail\./)}}),a({type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data},config:{services:await A(/^service\./),app:await A(/^app\.detail\./)},deprecated:{message:"FCL:FRAME:READY:RESPONSE is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}}),o&&a({jsonrpc:"2.0",id:s,method:"fcl:sign",params:[t,e.params]})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=G(e.data);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==s)return;const n=G(e.data.result);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":r(`Declined: ${n.reason||"No reason supplied"}`),t();break;default:r("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onMessage error",e),e}},onClose(){r("Declined: Externally Halted")}})})}};async function Le({service:e,msg:t={},opts:n={}}){try{return ve[e.method](e,t,n)}catch(a){throw console.error("execService({service, msg = {}, opts = {}})",a,{service:e,msg:t,opts:n}),a}}async function Pe(e,t){u(/^[0-9a-f]+$/i.test(e),"Message must be a hex string"),u(Array.isArray(t),"Must include an Array of composite signatures");let n=[],a=[],r=[];const s=await Promise.all(t.map(async e=>{u("string"==typeof e.addr,"addr must be a string"),u("number"==typeof e.keyId,"keyId must be a number"),u("string"==typeof e.signature,"signature must be a string");try{const t=await t(e.addr);return n.push(t.keys[e.keyId].weight.toFixed(1)),a.push(t.keys[e.keyId].signAlgo),r.push(e.signature),t.keys[e.keyId].publicKey}catch(e){throw e}}));return await _({cadence:`${Ae}`,args:(t,o)=>[t(e,o.String),t(s,o.Array([o.String])),t(n,o.Array(o.UFix64)),t(a,o.Array([o.UInt])),t(r,o.Array([o.String]))]})}const Ae="\nimport Crypto\n    \npub fun main(\n  message: String,\n  rawPublicKeys: [String],\n  weights: [UFix64],\n  signAlgos: [UInt],\n  signatures: [String],\n): Bool {\n\n  let keyList = Crypto.KeyList()\n  \n  var i = 0\n  for rawPublicKey in rawPublicKeys {\n    keyList.add(\n      PublicKey(\n        publicKey: rawPublicKey.decodeHex(),\n        signatureAlgorithm: signAlgos[i] == 2 ? SignatureAlgorithm.ECDSA_P256 : SignatureAlgorithm.ECDSA_secp256k1 \n      ),\n      hashAlgorithm: HashAlgorithm.SHA3_256,\n      weight: weights[i],\n    )\n    i = i + 1\n  }\n\n  let signatureSet: [Crypto.KeyListSignature] = []\n\n  var j = 0\n  for signature in signatures {\n    signatureSet.append(\n      Crypto.KeyListSignature(\n        keyIndex: j,\n        signature: signature.decodeHex()\n      )\n    )\n    j = j + 1\n  }\n    \n  let signedData = message.decodeHex()\n  \n  return keyList.verify(\n    signatureSet: signatureSet,\n    signedData: signedData\n  )\n}\n";function Ie(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return V({},z,{addr:v(e.addr||e.address),signature:e.signature||e.sig,keyId:e.keyId})}}const be="CURRENT_USER",Fe="CURRENT_USER/UPDATED",Oe='{\n  "f_type": "User",\n  "f_vsn": "1.0.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "expiresAt":null,\n  "services":[]\n}',Ne={[m]:async e=>{e.merge(JSON.parse(Oe));const n=await t.first(["fcl.storage","fcl.storage.default"]);if(n.can){const t=await(async e=>{const t=JSON.parse(Oe),n=await e.get(be);return null!=n&&t.f_vsn!==n.f_vsn?(e.removeItem(be),t):n||t})(n);ke(t)&&e.merge(t)}},[E]:(e,t)=>{e.subscribe(t.from),e.send(t.from,Fe,V({},e.all()))},[g]:(e,t)=>{e.unsubscribe(t.from)},SNAPSHOT:async(e,t)=>{t.reply(V({},e.all()))},SET_CURRENT_USER:async(e,n,a)=>{e.merge(a);const r=await t.first(["fcl.storage","fcl.storage.default"]);r.can&&r.put(be,e.all()),e.broadcast(Fe,V({},e.all()))},DEL_CURRENT_USER:async(e,n)=>{e.merge(JSON.parse(Oe));const a=await t.first(["fcl.storage","fcl.storage.default"]);a.can&&a.put(be,e.all()),e.broadcast(Fe,V({},e.all()))}},De=()=>f(Ne,be);function ke(e){return null==e.expiresAt||0===e.expiresAt||e.expiresAt>Date.now()}async function Te(){return new Promise(async(e,n)=>{De();const a=await Ue();if(a.loggedIn&&ke(a))return e(a);const r=await t.first(["discovery.wallet","challenge.handshake"]);try{if(null==r)throw console.warn('Required value for "discovery.wallet" not defined in config. See: https://github.com/onflow/flow-js-sdk/blob/master/packages/fcl/src/exec/query.md#configuration'),new Error('Required config value "discovery.wallet" is not defined')}catch(e){console.error(e)}const s=await t.first(["discovery.wallet.method","discovery.wallet.method.default"],"IFRAME/RPC");try{const t=await Le({service:{endpoint:r,method:s}});y(be,"SET_CURRENT_USER",await async function(e){var t=function(e=[],t=[]){return[...e,...t]}((e=function(e){return e.addr=e.addr?S(e.addr):null,e.paddr=e.paddr?S(e.paddr):null,e}(e)).services||[],await async function(e,t){if(null==e||null==t)return[];const n=new URL(e);n.searchParams.append("code",t);const a=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json());if(Array.isArray(a))return a;const r=[];if(Array.isArray(a.authorizations))for(let e of a.authorizations)r.push(V({type:"authz",keyId:a.keyId},e));return null!=a.provider&&r.push(V({type:"authn",id:"wallet-provider#authn"},a.provider)),r}(e.hks,e.code)).map(t=>function(e,t){try{return $[e.type](e,t)}catch(t){return console.error(`Unrecognized FCL Service Type [${e.type}]`,e,t),e}}(t,e));const n=function(e,t){return t.find(e=>"authn"===e.type)}(0,t);return V({},W,{addr:S(e.addr),cid:B(n),loggedIn:!0,services:t,expiresAt:e.exp})}(t))}catch(e){console.error("Error while authenticating",e)}finally{e(await Ue())}})}function _e(){De(),y(be,"DEL_CURRENT_USER")}async function Ve(e){De();const t=await Te(),n=J(t.services,"authz"),a=J(t.services,"pre-authz");return V({},e,a?{tempId:"CURRENT_USER",resolve:async(e,t)=>function(e){const t=(e=>({f_type:"PreAuthzResponse",f_vsn:"1.0.0",proposer:(e||{}).proposer,payer:(e||{}).payer||[],authorization:(e||{}).authorization||[]}))(e),n=[];null!=t.proposer&&n.push(["PROPOSER",t.proposer]);for(let e of t.payer||[])n.push(["PAYER",e]);for(let e of t.authorization||[])n.push(["AUTHORIZER",e]);return n.map(([e,t])=>({tempId:[t.identity.address,t.identity.keyId].join("|"),addr:t.identity.address,keyId:t.identity.keyId,signingFunction:e=>Le({service:t,msg:e}),role:{proposer:"PROPOSER"===e,payer:"PAYER"===e,authorizer:"AUTHORIZER"===e}}))}(await Le({service:a,msg:t}))}:{tempId:"CURRENT_USER",resolve:null,addr:v(n.identity.address),keyId:n.identity.keyId,sequenceNum:null,signature:null,signingFunction:async e=>Ie(await Le({service:n,msg:e,opts:{includeOlderJsonRpcCall:!0}}))})}function xe(e){De();const t="@EXIT",n=f(async n=>{for(n.send(be,E);;){const a=await n.receive();if(a.tag===t)return void n.send(be,g);e(a.data)}});return()=>y(n,t)}function Ue(){return De(),y(be,"SNAPSHOT",null,{expectReply:!0,timeout:0})}const We=e=>(u(/^[0-9a-f]+$/i.test(e),"Message must be a hex string"),{message:e});async function Me(e){De();const t=J((await Te()).services,"user-signature");u(t,"Current user must have authorized a signing service.");try{const n=await Le({service:t,msg:We(e)});return Array.isArray(n)?n.map(e=>Ie(e)):[Ie(n)]}catch(e){return e}}async function ze(e,t){return console.warn("\n    %cFCL/SDK Deprecation Notice\n    ============================\n    verifyUserSignatures is no longer exported as fcl.currentUser().verifyUserSignatures\n    and is now available as fcl.verifyUserSignatures\n    ============================\n    ","font-weight:bold;font-family:monospace;"),Pe(e,t)}let je=()=>({authenticate:Te,unauthenticate:_e,authorization:Ve,signUserMessage:Me,verifyUserSignatures:ze,subscribe:xe,snapshot:Ue});je.authenticate=Te,je.unauthenticate=_e,je.authorization=Ve,je.signUserMessage=Me,je.verifyUserSignatures=ze,je.subscribe=xe,je.snapshot=Ue;const He=async e=>n([a(e)]).then(r),Ye=e=>e.status>=4,$e=e=>e.status>=3,Be=e=>e.status>=2,Je={[m]:async e=>{const t=await He(e.self());Ye(t)||setTimeout(()=>e.sendSelf("POLL"),2500),e.merge(t)},[E]:(e,t)=>{e.subscribe(t.from),e.send(t.from,C,e.all())},[g]:(e,t)=>{e.unsubscribe(t.from)},[R]:async(e,t)=>{t.reply(e.all())},POLL:async e=>{const t=await He(e.self());var n,a;Ye(t)||setTimeout(()=>e.sendSelf("POLL"),2500),n=e.all(),a=t,JSON.stringify(n)!==JSON.stringify(a)&&e.broadcast(C,t),e.merge(t)}},qe=e=>{if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},Ke=e=>f(Je,qe(e));function Ge(e){function t(t){return h(qe(e),Ke,t)}function n(e){return function(n={}){const a=n.suppress||!1;return new Promise((n,r)=>{const s=t(t=>{t.statusCode&&!a?(r(t.errorMessage),s()):e(t)&&(n(t),s())})})}}return{snapshot:function(){return w(e,Ke)},subscribe:t,onceFinalized:n(Be),onceExecuted:n($e),onceSealed:n(Ye)}}async function Ze(t={}){try{await async function(t){u(F(t),"mutate(opts) -- opts is required"),u(O(t),"mutate(opts) -- opts must be an object"),u(F(t.cadence),"mutate({ cadence }) -- cadence is required"),u(N(t.cadence),"mutate({ cadence }) -- cadence must be a string"),u(await e.config.get("accessNode.api"),'Required value for "accessNode.api" not defined in config. See: https://github.com/onflow/flow-js-sdk/blob/master/packages/fcl/src/exec/query.md#configuration')}(t);const n=await e.config().get("fcl.authz",je().authorization);return e.send([e.transaction(t.cadence),e.args(T(t.args||[])),t.limit&&k(t.limit)&&e.limit(t.limit),e.proposer(t.proposer||t.authz||n),e.payer(t.payer||t.authz||n),e.authorizations(t.authorizations||[t.authz||n])]).then(e.decode)}catch(e){throw e}}Ge.isUnknown=e=>e.status>=0,Ge.isPending=e=>e.status>=1,Ge.isFinalized=Be,Ge.isExecuted=$e,Ge.isSealed=Ye,Ge.isExpired=e=>5===e.status;const Xe=async(e=[],n={})=>{const a=await t.first(["sdk.resolve"],n.resolve||s);return Array.isArray(e)&&(e=await o(i(),e)),JSON.stringify(c(await a(e)),null,2)},Qe=async e=>setTimeout(()=>e.sendSelf("TICK"),await t().get("fcl.eventPollRate",1e4)),et={TICK:async e=>{if(!e.hasSubs())return;let t=e.get("hwm");if(null==t)e.put("hwm",await d()),e.put("tick",await Qe(e));else{let a=await d();e.put("hwm",a);const s=await n([getEvents(e.self(),t.height,a.height-1)]).then(r);for(let t of s)e.broadcast("UPDATED",t.data);e.put("tick",await Qe(e))}},[E]:async(e,t)=>{e.hasSubs()||e.put("tick",await Qe(e)),e.subscribe(t.from)},[g]:(e,t)=>{e.unsubscribe(t.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))}},tt=e=>f(et,e);function nt(e){return{subscribe:t=>h(e,tt,t)}}const at=(e,t={})=>{window.location!==window.parent.location?window.parent.postMessage(V({},t,{type:e}),"*"):window.opener.postMessage(V({},t,{type:e}),"*")};var rt={__proto__:null,sendMsgToFCL:at,close:()=>{at("FCL:VIEW:CLOSE")},approve:e=>{at("FCL:VIEW:RESPONSE",{f_type:"PollingResponse",f_vsn:"1.0.0",status:"APPROVED",reason:null,data:e})},decline:e=>{at("FCL:VIEW:RESPONSE",{f_type:"PollingResponse",f_vsn:"1.0.0",status:"DECLINED",reason:e,data:null})},onMessageFromFCL:(e,t=(()=>{}))=>{const n=n=>{const{data:a}=n;"object"==typeof a&&null!=typeof a&&a.type===e&&t((e=>{var t;return e.deprecated&&console.warn("DEPRECATION NOTICE",e.deprecated.message),null==e||null==(t=e.body)||delete t.interaction,e})(a))};return window.addEventListener("message",n),()=>window.removeEventListener("message",n)},encodeMessageFromSignable:l,CompositeSignature:function(e,t,n){this.f_type=z.f_type,this.f_vsn=z.f_vsn,this.addr=S(e),this.keyId=Number(t),this.signature=n}};const st=()=>je().authenticate(),ot=()=>je().unauthenticate(),it=()=>(je().unauthenticate(),je().authenticate()),ct=()=>je().authenticate(),dt=()=>je().authenticate(),lt=je().authorization,ut=p;export{I as VERSION,rt as WalletUtils,st as authenticate,lt as authz,je as currentUser,nt as events,dt as logIn,Ze as mutate,_ as query,it as reauthenticate,Xe as serialize,ct as signUp,ut as t,Ge as tx,ot as unauthenticate,Pe as verifyUserSignatures};
//# sourceMappingURL=fcl.modern.js.map
